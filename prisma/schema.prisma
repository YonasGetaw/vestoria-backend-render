generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
}

enum PaymentMethod {
  COMMERCIAL_BANK
  TELEBIRR
  CBE_BIRR
}

enum OrderStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum TransactionType {
  SEND
}

enum WithdrawalMethod {
  COMMERCIAL_BANK
  TELEBIRR
  CBE_BIRR
}

enum WithdrawalStatus {
  PENDING
  APPROVED
  REJECTED
}

model User {
  id           String   @id @default(cuid())
  name         String
  email        String   @unique
  phone        String?  @unique
  passwordHash String
  withdrawPasswordHash String?
  role         Role     @default(USER)
  isActive     Boolean  @default(true)

  referralCode String?  @unique
  referredById String?
  referredBy   User?    @relation("UserReferrals", fields: [referredById], references: [id])
  referrals    User[]   @relation("UserReferrals")

  points Int @default(0)
  vipLevel Int @default(1)
  balanceCents Int @default(0)
  reservedBalanceCents Int @default(0)
  assetsCents Int @default(0)

  orders        Order[]
  withdrawals   Withdrawal[]
  sentTransactions     Transaction[] @relation("SentTransactions")
  receivedTransactions Transaction[] @relation("ReceivedTransactions")
  referralBonusesGiven ReferralBonus[] @relation("GivenReferralBonuses")
  referralBonusesReceived ReferralBonus[] @relation("ReceivedReferralBonuses")
  spinChancesGiven SpinChance[] @relation("SpinChancesGiven")
  spinChancesReceived SpinChance[] @relation("SpinChancesReceived")
  vipLevelRewards VipLevelReward[]
  dailyRewardPlans DailyRewardPlan[]
  dailyRewardClaims DailyRewardClaim[]
  refreshTokens RefreshToken[]
  resetTokens   PasswordResetToken[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SpinChance {
  id           String   @id @default(cuid())
  referrerId   String
  referredId   String   @unique
  grantedAt    DateTime @default(now())
  claimedAt    DateTime?
  rewardCents  Int?

  referrer User @relation("SpinChancesGiven", fields: [referrerId], references: [id], onDelete: Cascade)
  referred User @relation("SpinChancesReceived", fields: [referredId], references: [id], onDelete: Cascade)

  @@index([referrerId])
  @@index([referredId])
  @@index([claimedAt])
}

model VipLevelReward {
  id         String   @id @default(cuid())
  userId     String
  vipLevel   Int
  amountCents Int
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, vipLevel])
  @@index([userId])
}

model DailyRewardPlan {
  id              String   @id @default(cuid())
  userId          String   @unique
  dailyAmountCents Int
  totalDays       Int      @default(48)
  startsAt        DateTime
  endsAt          DateTime
  createdAt       DateTime @default(now())

  user   User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  claims DailyRewardClaim[]

  @@index([userId])
}

model DailyRewardClaim {
  id         String   @id @default(cuid())
  planId     String
  userId     String
  dayIndex   Int
  amountCents Int
  claimedAt  DateTime @default(now())

  plan DailyRewardPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  user User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, dayIndex])
  @@index([userId])
  @@index([planId])
}

model Withdrawal {
  id          String           @id @default(cuid())
  userId      String
  amountCents Int
  method      WithdrawalMethod

  accountName       String?
  accountNumber     String?
  phone             String?

  status     WithdrawalStatus @default(PENDING)
  approvedAt DateTime?
  rejectedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

model ReferralBonus {
  id          String   @id @default(cuid())
  referrerId  String
  referredId  String
  orderId     String
  amountCents Int
  tier        Int      // 1, 2, 3 based on product price
  createdAt   DateTime @default(now())

  referrer User @relation("GivenReferralBonuses", fields: [referrerId], references: [id], onDelete: Cascade)
  referred User @relation("ReceivedReferralBonuses", fields: [referredId], references: [id], onDelete: Cascade)

  @@index([referrerId])
  @@index([referredId])
  @@index([orderId])
}

model Transaction {
  id          String          @id @default(cuid())
  fromUserId  String
  toUserId    String
  amountCents Int
  type        TransactionType
  createdAt   DateTime        @default(now())

  fromUser User @relation("SentTransactions", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUser   User @relation("ReceivedTransactions", fields: [toUserId], references: [id], onDelete: Cascade)

  @@index([fromUserId])
  @@index([toUserId])
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String
  revokedAt DateTime?
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String
  usedAt    DateTime?
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Product {
  id          String   @id @default(cuid())
  name        String
  description String
  priceCents  Int
  imageUrl    String?
  isActive    Boolean  @default(true)

  orders Order[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PaymentSettings {
  id                     String   @id @default(cuid())
  commercialBankName     String
  commercialAccountNumber String
  telebirrPhone          String
  cbeBirrPhone            String

  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
}

model Order {
  id                   String        @id @default(cuid())
  userId               String
  productId            String
  status               OrderStatus   @default(PENDING)
  paymentMethod        PaymentMethod
  amountCents          Int
  paymentProofImageUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@index([userId])
  @@index([productId])
  @@index([status])
}
